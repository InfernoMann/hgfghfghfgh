<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>3D Shooter на three.js</title>
<style>
  body { margin: 0; overflow: hidden; background: #000; }
  #info { position: absolute; top: 10px; left: 10px; color: #fff; font-family: monospace; }
</style>
</head>
<body>
<div id="info">Очки: <span id="score">0</span></div>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/PointerLockControls.js"></script>

<script>
// === Основные переменные и сцена ===
let scene, camera, renderer, controls;
let player, bullets = [], enemies = [];
let score = 0;
const scoreElem = document.getElementById('score');

init();
animate();

function init() {
  // Сцена
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111);

  // Камера
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

  // Рендерер
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Управление (PointerLockControls)
  controls = new THREE.PointerLockControls(camera, document.body);
  document.body.addEventListener('click', () => {
    controls.lock();
  });

  // Свет
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5,10,7);
  scene.add(light);

  const ambient = new THREE.AmbientLight(0x404040);
  scene.add(ambient);

  // Игрок — невидимый объект, камера будет связана с ним
  player = new THREE.Object3D();
  player.position.set(0,1.6,0);  // рост человека ~1.6 метра
  scene.add(player);
  player.add(camera);

  // Пол (простая плоскость)
  const floorGeo = new THREE.PlaneGeometry(100, 100);
  const floorMat = new THREE.MeshStandardMaterial({color:0x222222});
  const floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  // Враги (создадим 10 штук)
  for(let i=0; i<10; i++) {
    spawnEnemy();
  }

  // Обработка ввода
  initInput();

  window.addEventListener('resize', onWindowResize);
}

// Обработка изменения размера окна
function onWindowResize() {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

// Ввод с клавиатуры
const keys = {};
function initInput() {
  document.addEventListener('keydown', e => keys[e.code] = true);
  document.addEventListener('keyup', e => keys[e.code] = false);

  // Стрельба по клику мыши
  document.addEventListener('mousedown', shoot);
}

// Функция создания врага
function spawnEnemy() {
  const size = 0.8;
  const geometry = new THREE.BoxGeometry(size, size, size);
  const material = new THREE.MeshStandardMaterial({color:0xff0000});
  const enemy = new THREE.Mesh(geometry, material);

  // Случайная позиция на расстоянии 20-30 по окружности от игрока
  const angle = Math.random()*Math.PI*2;
  const radius = 20 + Math.random()*10;
  enemy.position.set(Math.cos(angle)*radius, size/2, Math.sin(angle)*radius);

  enemy.userData = {
    health: 3,
    speed: 1 + Math.random()*0.5
  };

  scene.add(enemy);
  enemies.push(enemy);
}

// Стрельба — создаём пулю
function shoot() {
  if (!controls.isLocked) return;

  const bulletGeometry = new THREE.SphereGeometry(0.05, 8, 8);
  const bulletMaterial = new THREE.MeshBasicMaterial({color: 0xffff00});
  const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);

  // Пуля начинается из позиции камеры
  bullet.position.copy(camera.getWorldPosition(new THREE.Vector3()));

  // Направление — куда смотрит камера
  const direction = new THREE.Vector3();
  camera.getWorldDirection(direction);
  bullet.userData = {
    velocity: direction.multiplyScalar(30),  // скорость пули
    lifeTime: 2  // секунда жизни
  };

  scene.add(bullet);
  bullets.push(bullet);
}

// Обновление пуль
function updateBullets(delta) {
  for(let i = bullets.length-1; i >= 0; i--) {
    const b = bullets[i];
    b.position.addScaledVector(b.userData.velocity, delta);
    b.userData.lifeTime -= delta;
    if (b.userData.lifeTime <= 0) {
      scene.remove(b);
      bullets.splice(i,1);
      continue;
    }
    // Проверяем столкновения с врагами
    for(let j = enemies.length-1; j >= 0; j--) {
      const enemy = enemies[j];
      if (enemy.position.distanceTo(b.position) < 0.6) {
        enemy.userData.health--;
        if (enemy.userData.health <= 0) {
          scene.remove(enemy);
          enemies.splice(j,1);
          score++;
          scoreElem.textContent = score;
          spawnEnemy();  // создаём нового врага
        }
        scene.remove(b);
        bullets.splice(i,1);
        break;
      }
    }
  }
}

// Обновление врагов (движение к игроку)
function updateEnemies(delta) {
  const playerPos = player.position;
  enemies.forEach(enemy => {
    const dir = new THREE.Vector3().subVectors(playerPos, enemy.position);
    const dist = dir.length();
    if (dist > 1.2) {
      dir.normalize();
      enemy.position.addScaledVector(dir, enemy.userData.speed * delta);
    }
  });
}

// Обновление игрока (движение WASD)
function updatePlayer(delta) {
  if (!controls.isLocked) return;
  const speed = 5;
  const velocity = new THREE.Vector3();
  if (keys['KeyW']) velocity.z -= 1;
  if (keys['KeyS']) velocity.z += 1;
  if (keys['KeyA']) velocity.x -= 1;
  if (keys['KeyD']) velocity.x += 1;

  if (velocity.lengthSq() > 0) {
    velocity.normalize();
    // движение в направлении камеры
    const angle = camera.rotation.y;
    const forward = new THREE.Vector3(0,0,-1).applyEuler(camera.rotation);
    const right = new THREE.Vector3(1,0,0).applyEuler(camera.rotation);

    player.position.addScaledVector(forward, velocity.z * speed * delta);
    player.position.addScaledVector(right, velocity.x * speed * delta);

    // ограничим движение по полу
    player.position.y = 1.6;
  }
}

// Главный цикл анимации
let prevTime = performance.now();
function animate() {
  requestAnimationFrame(animate);

  const time = performance.now();
  const delta = (time - prevTime)/1000;

  updatePlayer(delta);
  updateEnemies(delta);
  updateBullets(delta);

  prevTime = time;

  renderer.render(scene, camera);
}
</script>
</body>
</html>
